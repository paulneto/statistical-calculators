<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K-Means Cluster Analysis Calculator</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://cdn.tailwindcss.com" rel="stylesheet">
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState } = React;

        const defaultData = `CustomerID,Age,Income,PurchaseFreq,AvgOrder
1,25,35000,2,45
2,45,75000,12,120
3,32,42000,3,55
4,52,85000,15,140
5,28,38000,2,50
6,48,78000,13,125
7,35,45000,4,60
8,55,90000,18,150
9,22,32000,1,40
10,50,80000,14,130
11,30,40000,3,52
12,46,72000,11,115
13,27,36000,2,48
14,53,88000,16,145
15,33,44000,4,58
16,49,76000,12,122
17,24,34000,2,42
18,51,82000,15,135
19,29,39000,3,51
20,47,74000,13,118
21,26,37000,2,46
22,54,86000,17,142
23,31,41000,3,54
24,50,79000,14,128
25,23,33000,1,41
26,48,77000,12,121
27,34,43000,4,57
28,52,84000,16,138
29,28,38000,2,49
30,46,73000,11,116
31,25,35000,2,44
32,53,87000,17,144
33,32,42000,3,56
34,49,78000,13,126
35,27,36000,2,47
36,51,81000,15,132
37,30,40000,3,53
38,54,89000,18,148
39,24,34000,1,43
40,47,75000,12,119`;

        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            const headers = lines[0].split(',');
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',');
                const row = {};
                headers.forEach((header, index) => {
                    row[header] = values[index];
                });
                data.push(row);
            }

            return { headers, data };
        }

        function euclideanDistance(point1, point2) {
            let sum = 0;
            for (let key in point1) {
                sum += Math.pow(point1[key] - point2[key], 2);
            }
            return Math.sqrt(sum);
        }

        function kMeans(data, k, features, maxIterations = 100) {
            const points = data.map(row => {
                const point = {};
                features.forEach(feature => {
                    point[feature] = parseFloat(row[feature]);
                });
                return point;
            });

            // Random initialization
            let centroids = [];
            const usedIndices = new Set();
            while (centroids.length < k) {
                const randomIndex = Math.floor(Math.random() * points.length);
                if (!usedIndices.has(randomIndex)) {
                    centroids.push({ ...points[randomIndex] });
                    usedIndices.add(randomIndex);
                }
            }

            let assignments = new Array(points.length).fill(0);
            let iterations = 0;
            let converged = false;

            while (!converged && iterations < maxIterations) {
                // Assign points to nearest centroid
                const newAssignments = points.map(point => {
                    let minDistance = Infinity;
                    let clusterIndex = 0;

                    centroids.forEach((centroid, index) => {
                        const distance = euclideanDistance(point, centroid);
                        if (distance < minDistance) {
                            minDistance = distance;
                            clusterIndex = index;
                        }
                    });

                    return clusterIndex;
                });

                // Check convergence
                converged = newAssignments.every((val, idx) => val === assignments[idx]);
                assignments = newAssignments;

                // Update centroids
                centroids = centroids.map((_, clusterIndex) => {
                    const clusterPoints = points.filter((_, idx) => assignments[idx] === clusterIndex);

                    if (clusterPoints.length === 0) {
                        return centroids[clusterIndex];
                    }

                    const newCentroid = {};
                    features.forEach(feature => {
                        newCentroid[feature] = clusterPoints.reduce((sum, point) => sum + point[feature], 0) / clusterPoints.length;
                    });

                    return newCentroid;
                });

                iterations++;
            }

            // Calculate WCSS
            let wcss = 0;
            points.forEach((point, idx) => {
                const centroid = centroids[assignments[idx]];
                wcss += Math.pow(euclideanDistance(point, centroid), 2);
            });

            return { assignments, centroids, wcss, iterations };
        }

        function calculateElbowData(data, features, maxK = 10) {
            const elbowData = [];

            for (let k = 1; k <= maxK; k++) {
                const result = kMeans(data, k, features);
                elbowData.push({ k, wcss: result.wcss });
            }

            return elbowData;
        }

        function getClusterSummary(data, assignments, centroids, features) {
            const clusters = centroids.map((centroid, index) => {
                const clusterPoints = data.filter((_, idx) => assignments[idx] === index);
                const size = clusterPoints.length;

                const stats = {};
                features.forEach(feature => {
                    const values = clusterPoints.map(row => parseFloat(row[feature]));
                    const mean = values.reduce((sum, val) => sum + val, 0) / values.length;
                    const min = Math.min(...values);
                    const max = Math.max(...values);
                    stats[feature] = { mean, min, max };
                });

                return { id: index + 1, size, centroid, stats };
            });

            return clusters;
        }

        function interpretCluster(cluster) {
            const age = cluster.centroid.Age;
            const income = cluster.centroid.Income;
            const freq = cluster.centroid.PurchaseFreq;
            const order = cluster.centroid.AvgOrder;

            let ageDesc = age < 30 ? "Young" : age < 45 ? "Middle-aged" : "Mature";
            let incomeDesc = income < 45000 ? "low-income" : income < 70000 ? "mid-income" : "high-income";
            let freqDesc = freq < 5 ? "infrequent" : freq < 12 ? "regular" : "frequent";
            let orderDesc = order < 60 ? "small purchases" : order < 100 ? "medium purchases" : "large purchases";

            return `${ageDesc}, ${incomeDesc}, ${freqDesc} buyers with ${orderDesc}`;
        }

        function ClusterAnalysisCalculator() {
            const [k, setK] = useState(3);
            const [csvData, setCsvData] = useState(defaultData);
            const [results, setResults] = useState(null);

            const calculate = () => {
                try {
                    const { headers, data } = parseCSV(csvData);
                    const features = headers.filter(h => h !== 'CustomerID');

                    // Perform K-means clustering
                    const { assignments, centroids, wcss, iterations } = kMeans(data, k, features);

                    // Calculate cluster summaries
                    const clusterSummary = getClusterSummary(data, assignments, centroids, features);

                    // Calculate elbow data
                    const elbowData = calculateElbowData(data, features, 10);

                    // Add cluster assignments to data
                    const dataWithClusters = data.map((row, idx) => ({
                        ...row,
                        Cluster: assignments[idx] + 1
                    }));

                    setResults({
                        clusterSummary,
                        elbowData,
                        wcss,
                        iterations,
                        dataWithClusters,
                        features
                    });
                } catch (error) {
                    alert('Error: ' + error.message);
                }
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-green-50 to-emerald-50 p-8">
                    <div className="max-w-6xl mx-auto">
                        <div className="bg-white rounded-lg shadow-lg p-8 mb-8">
                            <h1 className="text-4xl font-bold text-green-600 mb-2">K-Means Cluster Analysis Calculator</h1>
                            <p className="text-gray-600 mb-6">Segment customers into distinct groups based on multiple characteristics</p>

                            <div className="space-y-6">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        Number of Clusters (k)
                                    </label>
                                    <input
                                        type="number"
                                        min="1"
                                        max="10"
                                        value={k}
                                        onChange={(e) => setK(parseInt(e.target.value))}
                                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                    />
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        CSV Data (CustomerID, Age, Income, PurchaseFreq, AvgOrder)
                                    </label>
                                    <textarea
                                        value={csvData}
                                        onChange={(e) => setCsvData(e.target.value)}
                                        rows="10"
                                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent font-mono text-sm"
                                    />
                                </div>

                                <button
                                    onClick={calculate}
                                    className="w-full bg-gradient-to-r from-green-500 to-emerald-500 text-white py-3 rounded-lg hover:from-green-600 hover:to-emerald-600 transition-all duration-200 font-semibold"
                                >
                                    Perform Cluster Analysis
                                </button>
                            </div>
                        </div>

                        {results && (
                            <>
                                <div className="bg-white rounded-lg shadow-lg p-8 mb-8">
                                    <h2 className="text-2xl font-bold text-green-600 mb-4">Clustering Results</h2>
                                    <div className="grid grid-cols-2 gap-4 mb-6">
                                        <div className="bg-green-50 p-4 rounded-lg">
                                            <p className="text-sm text-gray-600">Within-Cluster Sum of Squares</p>
                                            <p className="text-2xl font-bold text-green-600">{results.wcss.toFixed(2)}</p>
                                        </div>
                                        <div className="bg-emerald-50 p-4 rounded-lg">
                                            <p className="text-sm text-gray-600">Iterations to Convergence</p>
                                            <p className="text-2xl font-bold text-emerald-600">{results.iterations}</p>
                                        </div>
                                    </div>
                                </div>

                                <div className="bg-white rounded-lg shadow-lg p-8 mb-8">
                                    <h2 className="text-2xl font-bold text-green-600 mb-4">Cluster Summaries</h2>
                                    <div className="space-y-6">
                                        {results.clusterSummary.map((cluster) => (
                                            <div key={cluster.id} className="border border-green-200 rounded-lg p-6">
                                                <div className="flex justify-between items-start mb-4">
                                                    <h3 className="text-xl font-bold text-green-600">Cluster {cluster.id}</h3>
                                                    <span className="bg-green-100 text-green-700 px-3 py-1 rounded-full text-sm font-semibold">
                                                        {cluster.size} customers
                                                    </span>
                                                </div>

                                                <div className="bg-emerald-50 p-4 rounded-lg mb-4">
                                                    <p className="text-sm font-medium text-gray-700 mb-1">Interpretation:</p>
                                                    <p className="text-gray-800 italic">{interpretCluster(cluster)}</p>
                                                </div>

                                                <div className="grid grid-cols-2 gap-4">
                                                    {results.features.map((feature) => (
                                                        <div key={feature} className="bg-gray-50 p-3 rounded">
                                                            <p className="text-sm font-medium text-gray-700">{feature}</p>
                                                            <p className="text-lg font-bold text-green-600">
                                                                {cluster.stats[feature].mean.toFixed(2)}
                                                            </p>
                                                            <p className="text-xs text-gray-500">
                                                                Range: {cluster.stats[feature].min.toFixed(1)} - {cluster.stats[feature].max.toFixed(1)}
                                                            </p>
                                                        </div>
                                                    ))}
                                                </div>

                                                <div className="mt-4 pt-4 border-t border-green-100">
                                                    <p className="text-sm font-medium text-gray-700 mb-2">Centroid Coordinates:</p>
                                                    <p className="text-sm text-gray-600 font-mono">
                                                        {results.features.map(f => `${f}: ${cluster.centroid[f].toFixed(2)}`).join(', ')}
                                                    </p>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>

                                <div className="bg-white rounded-lg shadow-lg p-8 mb-8">
                                    <h2 className="text-2xl font-bold text-green-600 mb-4">Elbow Plot Data</h2>
                                    <p className="text-gray-600 mb-4">Within-Cluster Sum of Squares (WCSS) for different values of k</p>
                                    <div className="overflow-x-auto">
                                        <table className="min-w-full">
                                            <thead>
                                                <tr className="bg-green-50">
                                                    <th className="px-4 py-2 text-left text-sm font-semibold text-green-700">k (clusters)</th>
                                                    <th className="px-4 py-2 text-left text-sm font-semibold text-green-700">WCSS</th>
                                                    <th className="px-4 py-2 text-left text-sm font-semibold text-green-700">Visual</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {results.elbowData.map((item, idx) => {
                                                    const maxWCSS = results.elbowData[0].wcss;
                                                    const barWidth = (item.wcss / maxWCSS) * 100;
                                                    return (
                                                        <tr key={idx} className="border-b border-gray-200">
                                                            <td className="px-4 py-2 font-medium">{item.k}</td>
                                                            <td className="px-4 py-2">{item.wcss.toFixed(2)}</td>
                                                            <td className="px-4 py-2">
                                                                <div className="w-full bg-gray-200 rounded-full h-4">
                                                                    <div
                                                                        className="bg-gradient-to-r from-green-500 to-emerald-500 h-4 rounded-full"
                                                                        style={{ width: `${barWidth}%` }}
                                                                    ></div>
                                                                </div>
                                                            </td>
                                                        </tr>
                                                    );
                                                })}
                                            </tbody>
                                        </table>
                                    </div>
                                    <div className="mt-4 p-4 bg-green-50 rounded-lg">
                                        <p className="text-sm text-gray-700">
                                            <strong>Tip:</strong> Look for the "elbow" point where the rate of decrease in WCSS sharply changes.
                                            This suggests the optimal number of clusters.
                                        </p>
                                    </div>
                                </div>

                                <div className="bg-white rounded-lg shadow-lg p-8">
                                    <h2 className="text-2xl font-bold text-green-600 mb-4">Customer Assignments</h2>
                                    <div className="overflow-x-auto">
                                        <table className="min-w-full text-sm">
                                            <thead>
                                                <tr className="bg-green-50">
                                                    <th className="px-3 py-2 text-left text-xs font-semibold text-green-700">Customer ID</th>
                                                    {results.features.map(feature => (
                                                        <th key={feature} className="px-3 py-2 text-left text-xs font-semibold text-green-700">{feature}</th>
                                                    ))}
                                                    <th className="px-3 py-2 text-left text-xs font-semibold text-green-700">Cluster</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {results.dataWithClusters.slice(0, 20).map((row, idx) => (
                                                    <tr key={idx} className="border-b border-gray-200">
                                                        <td className="px-3 py-2">{row.CustomerID}</td>
                                                        {results.features.map(feature => (
                                                            <td key={feature} className="px-3 py-2">{row[feature]}</td>
                                                        ))}
                                                        <td className="px-3 py-2">
                                                            <span className="bg-green-100 text-green-700 px-2 py-1 rounded text-xs font-semibold">
                                                                {row.Cluster}
                                                            </span>
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                        {results.dataWithClusters.length > 20 && (
                                            <p className="text-sm text-gray-500 mt-2">
                                                Showing first 20 of {results.dataWithClusters.length} customers
                                            </p>
                                        )}
                                    </div>
                                </div>

                                {/* Back Button */}
                                <div className="mt-8 text-center">
                                    <a href="../index.html" className="text-green-600 hover:text-green-800 font-semibold">
                                        ‚Üê Back to Calculator Collection
                                    </a>
                                </div>
                            </>
                        )}
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ClusterAnalysisCalculator />);
    </script>
</body>
</html>
